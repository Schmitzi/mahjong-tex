\NeedsTeXFormat{LaTeX2e}
\RequirePackage{xparse}
\RequirePackage{expl3}
\RequirePackage{graphicx}
\RequirePackage{stackengine}
\ProvidesExplPackage{mahjong}{2021/04/04}{0.1}{Typeset Mahjong Hands}

% Identifiers for all suits
\cs_new:Npn \c_suits_str {mpszf}

% Variables have to be declared globally
\str_new:N \l_suit_str
\str_new:N \l_tiles_str
\str_new:N \l_reversed_str
\str_new:N \l_hand_str
\str_new:N \l_current_suit_str
\str_new:N \l_current_group_str
\str_new:N \l_current_char

% Output token list. Because we parse the hand in reverse, we must reverse the result
\tl_new:N \l_output_tl

\cs_set:Npn \make_tile:nn #1#2 {
    \stackinset{c}{0pt}{c}{0pt}{
    \includegraphics[height=.95\baselineskip]{tiles/#1#2.pdf}}{
    \includegraphics[width=\baselineskip]{tiles/Front.pdf}}
}

\cs_generate_variant:Nn \make_tile:nn {VV}

% Parses a group of tiles belonging to the same suit
\cs_set:Npn \parse_group:nn #1#2 {
    \str_set:Nn \l_suit_str {#1}
    \str_set:Nn \l_tiles_str {#2}
    \str_map_variable:NNn \l_tiles_str \l_tmpa_str {
        \str_if_eq:VnTF \l_tmpa_str {~} { % If there is a tilde, insert a space
            \hspace{.5\baselineskip}
        } { % Otherwise insert full notation
            %TODO: replace with images
            \make_tile:VV {\l_tmpa_str} {\l_suit_str}
        }
    }
}

\cs_generate_variant:Nn \parse_group:nn { Vn, nV, VV }

% Parses a full hand
\cs_set:Npn \parse_hand:n #1 {
    \str_set:Nn \l_hand_str {#1} 
    % MPSZ notation is easier to parse right-to-left, so reverse string
    % There is no string reversal function but we can reverse token lists
    % Token lists and strings are freely convertible between each other
    \tl_set:Nx \l_tmpa_tl {\tl_reverse:V \l_hand_str}
    \str_set:Nx \l_reversed_str {\tl_to_str:N \l_tmpa_tl}

    \str_map_variable:NNn \l_reversed_str \l_current_char {
        \exp_args:NVV \str_if_in:nnTF \c_suits_str \l_current_char {
            % If we've found a suit identifier, typeset the current group
            \parse_group:VV \l_current_suit_str \l_current_group_str
            % Start the next group
            \str_clear:N \l_current_group_str
            \str_set:NV \l_current_suit_str \l_current_char
        } {
            % If the current symbol does not match a suit, assume it's part of the group
            \str_put_right:NV \l_current_group_str \l_current_char
        }
    }
    \parse_group:VV \l_current_suit_str \l_current_group_str
}

% Have TeX automatically expand the argument for us
\cs_generate_variant:Nn \parse_hand:n {x}

% Macro for LaTeX document
\NewDocumentCommand{\mahjong}{m}{
    \parse_hand:n {#1}
}

\endinput